name: Windows Build & Release

on:
  push:
    branches: [ "master" ]
    tags:
      - 'v*'  # WICHTIG: Reagiert jetzt auch auf Tags wie v0.1, v1.0 etc.

jobs:
  build:
    name: Build & Deploy
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Create Build Directory
        run: mkdir build

      - name: Configure CMake
        working-directory: build
        run: cmake .. -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release

      - name: Build
        working-directory: build
        run: nmake

      - name: Prepare Deployment
        run: mkdir deployment

      - name: Copy Executable
        run: copy build\Blop.exe deployment\Blop.exe

      - name: Run windeployqt
        run: windeployqt --dir deployment deployment\Blop.exe

      - name: Zip Release
        uses: TheDoctor0/zip-release@0.7.1
        with:
          type: 'zip'
          filename: 'Blop_Windows.zip'
          directory: 'deployment'

      # FALL 1: ECHTES RELEASE (Wenn ein Tag gepusht wurde, z.B. v0.1)
      # LÃ¤dt die Datei in das Release hoch, das durch den Tag erstellt wurde.
      # Da Android und Windows denselben Tag haben, landen beide Dateien im selben Release.
      - name: Upload Versioned Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          # Kein tag_name angegeben -> nutzt automatisch den aktuellen Tag (v0.1)
          files: deployment/Blop_Windows.zip
          draft: false
          prerelease: false
          repository: BenSchwank/Blop-releases

      # FALL 2: NIGHTLY BUILD (Nur wenn auf 'master' gepusht wurde, ohne Tag)
      - name: Upload Nightly Release
        if: github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          tag_name: nightly
          name: Nightly Build (Latest)
          body: "Neuester automatischer Build."
          files: deployment/Blop_Windows.zip
          draft: false
          prerelease: true
          overwrite: true
          repository: BenSchwank/Blop-releases
