name: Windows Build & Release

on:
  push:
    branches: [ "master" ]
    tags:
      - 'v*'

jobs:
  build:
    name: Build & Deploy
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Qt via aqtinstall
        shell: pwsh
        run: |
          pip install aqtinstall

          # Definiere das Zielverzeichnis explizit
          $qtDir = "${{ runner.workspace }}\Qt"

          # Installiere Qt 6.7.2 direkt in dieses Verzeichnis
          # WICHTIG: --outputdir $qtDir sorgt dafür, dass die Pfade stimmen
          aqt install-qt windows desktop 6.7.2 win64_msvc2019_64 -m qtwebengine qtwebchannel qtpositioning --outputdir $qtDir

          # Setze den Pfad zur Installation
          $qtBase = "$qtDir\6.7.2\msvc2019_64"

          # Überprüfung: Existiert qmake?
          if (-not (Test-Path "$qtBase\bin\qmake.exe")) {
            Write-Error "Qt Installation fehlgeschlagen! Pfad nicht gefunden: $qtBase"
            exit 1
          }

          echo "Qt erfolgreich installiert in: $qtBase"

          # Environment Variables für CMake setzen
          echo "QT_ROOT=$qtBase" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$qtBase\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Create Build Directory
        run: mkdir build

      - name: Configure CMake
        working-directory: build
        # CMAKE_PREFIX_PATH zeigt jetzt auf den validierten Qt-Ordner
        run: cmake .. -G "NMake Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ env.QT_ROOT }}"

      - name: Build
        working-directory: build
        run: nmake

      - name: Prepare Deployment
        run: |
          mkdir deployment
          copy build\Blop.exe deployment\Blop.exe

      # windeployqt muss ebenfalls den korrekten Pfad nutzen (ist aber durch PATH bereits verfügbar)
      - name: Run windeployqt
        shell: cmd
        run: |
          windeployqt --dir deployment deployment\Blop.exe --release --compiler-runtime --no-translations --no-opengl-sw

      - name: Check WebEngine Deployment
        shell: pwsh
        run: |
          if (!(Test-Path "deployment\Qt6WebEngineCore.dll")) { Write-Error "CRITICAL: Qt6WebEngineCore.dll missing!" }
          if (!(Test-Path "deployment\QtWebEngineProcess.exe")) { Write-Error "CRITICAL: QtWebEngineProcess.exe missing!" }
          if (!(Test-Path "deployment\resources")) { Write-Error "CRITICAL: Resources folder missing!" }

      - name: Zip Release
        uses: TheDoctor0/zip-release@0.7.1
        with:
          type: 'zip'
          filename: 'Blop_Windows.zip'
          directory: 'deployment'

      - name: Upload Versioned Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          files: deployment/Blop_Windows.zip
          draft: false
          prerelease: false
          repository: BenSchwank/Blop-releases

      - name: Upload Nightly Release
        if: github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          tag_name: nightly
          name: Nightly Build (Latest)
          body: "Neuester automatischer Build mit WebEngine."
          files: deployment/Blop_Windows.zip
          draft: false
          prerelease: true
          overwrite: true
          repository: BenSchwank/Blop-releases
